# AWS - SQL Server から Amazon RDS for SQL Server への移行ハンズオンメモ

- ハンズオン URL：
  [SQL Server から Amazon RDS for SQL Server への移行ハンズオン](https://master.d1oy109z3xffu3.amplifyapp.com/02_scenario2.html)

## 学習の流れ

下記の流れでハンズオンを実施。  
ハンズオンプログラムには「Oracle⇒RDSforOracle」「Oracle⇒RDSforPostgreSQL」も含まれていたが、  
今回は「SQLServer⇒RDS」のみ実施した。

1. CloudFormation テンプレートを使用した環境構築
2. dump ファイルから RDS への移行
3. レプリケーションによる RDS への移行

## 今回ハンズオン実施した環境

- dump ファイルからの移行
  ![実施環境](https://master.d1oy109z3xffu3.amplifyapp.com/02_scenario2/02_handson2/2/01.png)

- レプリケーションによる移行
  ![実施環境](https://master.d1oy109z3xffu3.amplifyapp.com/02_scenario2/03_handson3/1/01.png)

## 1. CloudFormation テンプレートを使用した環境構築

ハンズオン環境の構築は CloudFormation テンプレートから行った。  
必要なものはほとんどテンプレートに組み込まれていた。  
そこそこの性能で作成されるので、長く起動し続けると料金が高くなるため注意が必要。

- テンプレートの内容

  - VPC(上記ハンズオン環境図の通り)
  - EC2 インスタンス(WindowsServer SQLServer 導入済み)
  - RDS for SQLServer

- 自身で作成したもの
  - キーペア
  - S3 バケット

## 2. dump ファイルから RDS への移行

SQLServer の DB バックアップとして作成した dump ファイルから RDS に DB 移行する。  
dump ファイルはテスト用に準備されているものを使用。

＜移行手順＞

1. RDS のオプショングループを作成し、S3 バケットへの接続権限を設定  
   復元する dump ファイル置き場に復元先の RDS からアクセスできるようにするための設定を行う。

2. S3 バケットに dump ファイルをアップロード  
   dump ファイル置き場として、S3 バケットを使用する。  
   移行元の SQLServer でバックアップ作成し、それを S3 バケットに配置しておく。

3. dump ファイルから RDS に復元  
   SQLServer から RDS に接続して操作するため、RDS のエンドポイントを指定して DB 接続する。  
   RDS は作成時点で事前に復元用のプロシージャ(rds_restore_database)を用意してくれているので、これを実行する。  
   実行時に dump を置いた S3 バケットと復元する DB 名を指定して実行する。

> 事前に AWS 側が自動で RDS に復元用のプログラムを作成しておいてくれるため、  
> dump ファイルを用意するだけでとても簡単に移行できると感じた。  
> 特に難しい操作もなくすぐに移行できた。

## 3. レプリケーションによる RDS への移行

SQLServer のレプリケーション(複製)機能による、RDS への移行を行う。  
常に同期をとる機能なので、リアルタイムに RDS に同期し続けることを確認する。

＜移行手順＞

1. RDS に移行先となる DB とスキーマを作成  
   移行元から同期するための同期先となる DB、スキーマを作成する

2. 移行元で継続的なトランザクションを発生させる  
   リアルタイムにトランザクション処理の同期を確認したいので、継続的にトランザクションを発生させる。  
   今回はテスト用に用意されたプロシージャを実行し、テーブルにデータを挿入し続けた。(停止させるまで実行し続ける)

3. RDS にレプリケーション対象のテーブルを作成  
   移行元と同じ構成のテーブルを作成する。

4. 移行元でディストリビューションを作成  
   SQLServer のレプリケーションは、

   - ディストリビューション：データ同期を実行する。パブリッシャーとサブスクリプションを管理する。
   - パブリッシャー：同期元となる DB を管理する。
   - サブスクリプション：同期先となる DB を管理する。

   これらを使用して行われるため、まずはディストリビューションを作成する。  
   ウィザードに沿って作成するだけ。

5. 移行元でパブリッシャーを作成  
   これもウィザードに沿って作成するだけ。  
   ウィザードでは同期するテーブルと DB 接続するための ID とパスワードを登録する。  
   作成後、パブリッシャーの状況をモニターでき、LogReader が動いていることを確認できるようになる。  
   LogReader によりトランザクション操作を拾ってくることができる。

6. 移行元で RDS に接続するためのホスト名を登録  
   サブスクライバーを作成する前に、RDS のホスト名を名前解決できるように設定が必要となる。
   RDS のエンドポイントに対して nslookup コマンドを実行して IP アドレスを確認する。  
   hosts ファイルに IP アドレスとホスト名のペアを書き込んで保存しておく。

7. 移行元でサブスクライバーを作成  
   これも同じくウィザードに沿って作成。  
   RDS に接続するためのホスト名、ID、PASS を登録することになる。  
   エンドポイントではなくホスト名で登録する必要がある。

8. RDS への同期を確認する
   以上で設定は完了。  
   最初に継続的にトランザクションを発生させるプロシージャを実行しているので、常にデータが作成されている状態なっている。  
   移行元と移行先のテーブルで select することでデータが同期されていることを確認する。  
   また、サブスクライバーのメニューでレプリケーションの実行状況を確認することもできる。

> dump からの移行より複雑で SQLServer レプリケーションの知識が前提として必要だったが、順序立ててわかりやすく体験できる内容だった。  
> バックアップ用として RDS を活用するには必要となる知識なので、RDS で DB 運用を考えている人にはこのハッカソンはとても有効だと感じた。
