# AWS - Introduction to Amazon ECS ハンズオンメモ

Amazon ECS 環境で、コンテナ化されたアプリケーションをデプロイする方法についての学習。  
アプリケーションは Ruby のフレームワークである Sinatra を利用したチャットアプリがサンプルとして提供される。

- ハンズオン URL：
  [Introduction to Amazon ECS ハンズオン](https://catalog.us-east-1.prod.workshops.aws/workshops/a2b9971a-7a6e-40f3-96e7-5a04b46d1f98/ja-JP)

- 今回作成した環境
  ![今回作成した環境](https://static.us-east-1.prod.workshops.aws/public/a5d3aad0-1d63-460e-aab7-7dc6017a7c1a/static/images/architecture_all.png)

## 学習の流れ

1. 環境構築
   - AWS CloudFormation を使用してテンプレートから環境作成(ECS,ECR,Fargate 以外の部分)
2. アプリケーションのデプロイ
   - Docker コンテナイメージを作成し ECR に保存
   - ECS で ECR に保存した Docker コンテナを実行
3. サンプルアプリケーション動作確認
   - WEB アプリケーションの動作確認
   - ECR コンテナイメージ更新内容による ECS への反映確認

## 1. 環境構築

### AWS CloudFormation を使用してテンプレートから環境作成(ECS,ECR,Fargate 以外の部分)

ハンズオンで用意されている CloudFormation テンプレートを使用して環境構築を行う。  
テンプレートファイルには ECS,ECR,Fargate 以外の環境が構築できるように指定されている。

**この中で RDS の設定があるが、MySQL の指定バージョンが古く、エラーで作成できないため、MySQL のバージョンは AWS 側で対応しているバージョンに json ファイルを修正する必要があった。**  
それ以外は特に問題はなく、環境が自動で構築された。

CloudFormation で環境構築すると後片付けが楽で、CloudFormation のテンプレートを削除するだけでテンプレートから作成したサービスを全て削除してくれる。

これで本題のコンテナ部分以外の環境は整った。

## 2. アプリケーションのデプロイ

### Docker コンテナイメージを作成し ECR に保存

- ECR リポジトリの作成  
  AWS でコンテナを使用するために、コンテナイメージを保存できる ECR を使用する。  
  ECR はただのリポジトリのため、一意の名前を付けてリポジトリ作成を行うだけ。  
  リポジトリを作成したらコンテナイメージを push して入れる必要がある。  
  ECR ではリポジトリ毎に push するために必要な push コマンドを生成してくれるので、それをコピーして実行するだけで入れることができる。

- コンテナイメージの作成  
  サンプルアプリケーションを含んだコンテナイメージを作成するために、Cloud9 という AWS の開発環境を使用する。  
  Docker ファイル、サンプルアプリケーションが準備されているため、Cloud9 上でダウンロードする。  
  Cloud9 のターミナルで、先程の ECR リポジトリに対して生成された push コマンドを実行し、ECR にコンテナイメージを push する。  
  push コマンド一覧の中にコンテナイメージのビルドコマンドも含まれており、コマンドを順番に実行するだけで、ECR にコンテナイメージを入れることができる。

  **※ハンズオン手順通りにやると、この push コマンドが実行できなかった。  
  Cloud9 は EC2 サーバで動いており、EC2 に Admin 権限が無いと認証コマンドが実行できないことが原因だった。  
  手順にはないが、IAM で EC2 用の Admin ロールを作成し、Cloud9 を実行する EC2 に Admin ロールを付与する必要がある。**

### ECS で ECR に保存した Docker コンテナを実行

- ECS 環境の作成  
  コンテナイメージを実行するために ECS 環境を作成する。  
  ECS は

  - ECS クラスタ：タスクとサービスをグループ化し管理する。
  - ECS タスク：ECS がどの コンテナイメージを使用し、どのようなリソース(CPU、メモリなど)を割り当て、どのようなネットワーク設定を行うかなどを定義する。
  - ECS サービス：タスクの実行とスケーリングを管理する。

  これらの要素で構成されている。

  - ECS クラスタの作成  
    今回はサーバーレスなコンテナ実行エンジンである、AWSFargate を使用している。  
    コンテナ化されたアプリケーションを ECS クラスタ上で実行する際、その基盤となるサーバーを指定する必要があるが、そこで AWSFargate を選択している。  
    ここで、EC2 を選択することもできるが、AWSFargate はサーバーレスのため、サーバーの管理が不要になるので楽。

  - タスク定義の作成  
    コンテナイメージの指定、リソースの割り当て、ネットワーク設定を行う。  
    1.環境構築で作成されている RDS への指定も行っており、アプリケーションのデータ保存先を指定している。  
    ECS クラスタにあわせて起動タイプを AWSFargate にしておく。

  - ECS サービス  
    ECS サービスを作成し、作成したタスク定義を指定する。  
    管理するタスクを指定し、サービス名、タスクを配置するサブネット(AZ 分散させたりセキュリティ要件を満たすことができる)、ロードバランサー(サービスがタスクへの通信を分散する)などを設定して作成する。
    サービスの更新方式はローリングアップデートを設定（新旧のタスクが一時的に共存する期間を設け一部のタスクを更新しつつ、他のタスクは引き続き稼働させる更新方式）

## 3. サンプルアプリケーション動作確認

- WEB アプリケーションの動作確認  
  ALB にアクセスしてアプリケーションを開く。
  ![アプリ画面](https://static.us-east-1.prod.workshops.aws/public/a5d3aad0-1d63-460e-aab7-7dc6017a7c1a/static/images/comment.png)

  このようなチャットアプリが動作していることが確認できる。  
  実際にコメントを送信することで、コメントが蓄積され表示されていく。

  AWS Fargate で起動されたコンテナ内のアプリケーションへのアクセスが確認できた。

- ECR コンテナイメージ更新内容による ECS への反映確認  
  コンテナ内のアプリケーションの修正とデプロイについても実施した。  
  アプリケーションの修正は同じく Cloud9 で実施する。  
  ソースコードを修正し、再度 ECR の push コマンドを順に実行する。  
  これにより、docker ビルドコマンドが実行され、ECR のコンテナイメージが最新に置き換わる。(タグ管理により、別イメージとして扱うこともできる)

  ECS サービスの設定を開き、新しいデプロイの強制を ON にする。
  これでコンテナイメージが最新になると、ECS のタスク定義を自動で更新し、サービスを再デプロイしてくれるようになる。

  実際にアプリ画面のヘッダ文字を修正し、数分待つことで、アプリを停止せずに修正部分の反映を確認できた。

## 感想

全体的に説明が少ないと感じたので、各機能について自身で調べながら進めていった。  
ハンズオンの構成としてはスムーズにいくもので（一部エラー対応が必要だったが）、機能についてそこまで理解がなくても、手順通り進めることでアプリの起動まで進められる構成だと感じた。  
ハンズオン資料は古くなるので、エラー対応が必要になることが多いが、
コンテナ、VPC、IAM について、少し事前知識を得ておくと、理解もしやすいしエラー対応もスムーズになると感じた。
